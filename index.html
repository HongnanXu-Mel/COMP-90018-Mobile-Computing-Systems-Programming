<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>å¢¨å°”æœ¬ CBD é¤å…å®šä½ - Maps JS + Places</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* é¡µé¢å¸ƒå±€ */
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .app { display: grid; grid-template-columns: 380px 1fr; height: 100%; }
    .sidebar {
      border-right: 1px solid #e5e7eb; padding: 12px; overflow: auto; background: #fafafa;
      display: grid; grid-template-rows: auto auto 1fr auto; gap: 10px;
    }
    .toolbar { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .filters { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .filters label { font-size: 12px; color: #374151; }
    .filters select, .filters input, .toolbar button {
      width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 10px; background: white;
    }
    .toolbar button { cursor: pointer; border: 1px solid #2563eb; color: white; background: #2563eb; }
    .toolbar button.secondary { border-color: #6b7280; background: #6b7280; }
    .results { overflow: auto; display: grid; gap: 8px; }
    .card {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      cursor: pointer;
    }
    .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.06); }
    .card .title { font-weight: 600; margin-bottom: 4px; }
    .meta { font-size: 12px; color: #4b5563; display: flex; gap: 8px; flex-wrap: wrap; }
    .addr { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .pagination { display: flex; gap: 8px; padding: 8px 0; }
    .pagination button {
      padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 10px; background: white; cursor: pointer;
    }
    .map { position: relative; }
    #map { width: 100%; height: 100%; }
    .details {
      position: absolute; right: 12px; top: 12px; width: 320px; max-height: 80%; overflow: auto;
      background: rgba(255,255,255,0.98); border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12); display: none;
    }
    .details .title { font-weight: 700; font-size: 16px; margin-bottom: 6px; }
    .details .row { font-size: 13px; margin: 4px 0; color: #374151; }
    .badge { padding: 2px 6px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 11px; color: #374151; }
    .hint { font-size: 12px; color: #6b7280; }
    .cbd-badge { position: absolute; left: 12px; top: 12px; background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:12px;}
    .footnote { font-size: 11px; color:#6b7280; }
  </style>
  <!-- ç”¨ä½ çš„ API Key æ›¿æ¢ YOUR_API_KEYï¼›æ³¨æ„ libraries=places & callback=initMap & v=weekly -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&v=weekly&callback=initMap" async defer></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div>
        <h2 style="margin:0 0 6px;">å¢¨å°”æœ¬ CBD é¤å…</h2>
        <div class="hint">åŸºäº Google Maps JS + Placesï¼ˆå‰ç«¯çº¯é™æ€é¡µé¢ï¼‰</div>
      </div>

      <div class="filters">
        <div>
          <label for="minRating">è¯„åˆ†ä¸‹é™</label>
          <select id="minRating">
            <option value="0">ä¸é™</option>
            <option value="3.5">â‰¥ 3.5</option>
            <option value="4.0" selected>â‰¥ 4.0</option>
            <option value="4.5">â‰¥ 4.5</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <label style="display:flex; align-items:center; gap:6px; margin-bottom: 0;">
            <input id="onlyOpen" type="checkbox" checked /> åªçœ‹â€œè¥ä¸šä¸­â€
          </label>
        </div>
      </div>

      <div class="toolbar">
        <button id="btnSearch">åœ¨ CBD æœé¤å…</button>
        <button class="secondary" id="btnClear">æ¸…é™¤æ ‡è®°</button>
      </div>

      <div class="results" id="results"></div>

      <div class="pagination">
        <button id="btnPrev" disabled>ä¸Šä¸€é¡µ</button>
        <button id="btnNext" disabled>ä¸‹ä¸€é¡µ</button>
      </div>

      <div class="footnote">
        å°è´´å£«ï¼šç‚¹å‡»åˆ—è¡¨æˆ–åœ°å›¾æ ‡è®°å¯çœ‹è¯¦æƒ…ï¼ˆç½‘ç«™ã€ç”µè¯ã€è¥ä¸šæ—¶é—´ç­‰ï¼‰ã€‚
      </div>
    </aside>

    <main class="map">
      <div id="map"></div>
      <div class="cbd-badge">åŒºåŸŸï¼šMelbourne CBDï¼ˆHoddle Gridï¼‰</div>
      <div class="details" id="details"></div>
    </main>
  </div>

  <script>
    let map, placesService, infoWindow;
    let markers = [];
    let lastResults = [];
    let pagination = { prev: null, next: null };
    const resultsEl = document.getElementById('results');
    const detailsEl = document.getElementById('details');

    // ç²—ç•¥åœˆå®š CBDï¼ˆHoddle Gridï¼‰è¾¹ç•Œï¼Œä¾¿äºé™åˆ¶æœç´¢èŒƒå›´
    // ä½ ä¹Ÿå¯ä»¥ç”¨æ›´ç²¾ç¡®çš„ polygonï¼›è¿™é‡Œç”¨ bounds å³å¯ã€‚
    const CBD_BOUNDS = new google.maps.LatLngBounds(
      new google.maps.LatLng(-37.8265, 144.9515), // SW
      new google.maps.LatLng(-37.8060, 144.9755)  // NE
    );
    const CBD_CENTER = { lat: -37.8136, lng: 144.9631 };

    window.initMap = function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: CBD_CENTER,
        zoom: 15,
        mapId: 'DEMO_MAP_ID' // å¯é€‰ï¼šå¦‚æœä½ åˆ›å»ºäº† MapIDï¼Œå¯æ›¿æ¢
      });
      map.fitBounds(CBD_BOUNDS);
      placesService = new google.maps.places.PlacesService(map);
      infoWindow = new google.maps.InfoWindow();

      // ç”»å‡º CBD è¾¹ç•Œçš„å¯è§†åŒ–æ¡†ï¼ˆä»…ä½œæç¤ºï¼Œéå¿…é¡»ï¼‰
      new google.maps.Rectangle({
        bounds: CBD_BOUNDS,
        map,
        strokeColor: '#2563eb',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#2563eb',
        fillOpacity: 0.06
      });

      document.getElementById('btnSearch').addEventListener('click', doSearch);
      document.getElementById('btnClear').addEventListener('click', clearMarkers);
      document.getElementById('btnNext').addEventListener('click', () => pagination.next && pagination.next());
      document.getElementById('btnPrev').addEventListener('click', () => pagination.prev && pagination.prev());

      // åˆæ¬¡åŠ è½½è‡ªåŠ¨æœä¸€é
      doSearch();
    }

    function doSearch() {
      clearMarkers();
      resultsEl.innerHTML = 'æ­£åœ¨æœç´¢â€¦';

      const minRating = parseFloat(document.getElementById('minRating').value || '0');
      const onlyOpen = document.getElementById('onlyOpen').checked;

      // Nearby Searchï¼ˆåŸºäºåŠå¾„ + ç±»å‹ï¼‰ï¼Œå†ç»“åˆ bounds åšè§†è§‰é™åˆ¶
      const request = {
        location: CBD_CENTER,
        radius: 900,               // 900 ç±³è¦†ç›–å¤§éƒ¨åˆ† Hoddle Grid
        type: 'restaurant',
        openNow: onlyOpen || undefined
      };

      placesService.nearbySearch(request, (results, status, pag) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results) {
          resultsEl.innerHTML = 'æœªæ‰¾åˆ°ç»“æœæˆ–å‡ºé”™ã€‚';
          setPagination(null, null);
          return;
        }

        // è¿‡æ»¤åœ¨ CBD_BOUNDS å†… + è¯„åˆ†ï¼ˆè‹¥è®¾å®šäº†ä¸‹é™ï¼‰
        const filtered = results.filter(r => {
          const inCBD = CBD_BOUNDS.contains(r.geometry?.location);
          const ratingOK = !minRating || (r.rating || 0) >= minRating;
          return inCBD && ratingOK;
        });

        lastResults = filtered;
        renderResults(filtered);
        addMarkers(filtered);

        // å¤„ç†åˆ†é¡µ
        setPagination(
          pag?.hasPrevPage ? () => { pag.previousPage(); } : null,
          pag?.hasNextPage ? () => { pag.nextPage(); } : null
        );
      });
    }

    function setPagination(prevFn, nextFn) {
      pagination.prev = prevFn;
      pagination.next = nextFn;
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      btnPrev.disabled = !prevFn;
      btnNext.disabled = !nextFn;
    }

    function addMarkers(places) {
      const bounds = new google.maps.LatLngBounds();
      places.forEach((place, idx) => {
        if (!place.geometry || !place.geometry.location) return;
        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location,
          label: String((idx + 1)),
          title: place.name
        });
        marker.addListener('click', () => {
          selectPlace(place, marker);
        });
        markers.push(marker);
        bounds.extend(place.geometry.location);
      });
      if (!bounds.isEmpty()) {
        const union = new google.maps.LatLngBounds(CBD_BOUNDS.getSouthWest(), CBD_BOUNDS.getNorthEast());
        union.union(bounds);
        map.fitBounds(union, 50);
      }
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
      resultsEl.innerHTML = '';
      detailsEl.style.display = 'none';
      infoWindow.close();
    }

    function renderResults(places) {
      if (!places.length) {
        resultsEl.innerHTML = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¤å…ã€‚è¯·æ”¾å®½ç­›é€‰ã€‚';
        return;
      }
      resultsEl.innerHTML = '';
      places.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="title">${idx + 1}. ${escapeHtml(p.name || 'æœªå‘½å')}</div>
          <div class="meta">
            <span class="badge">è¯„åˆ†ï¼š${p.rating ?? 'â€”'}</span>
            <span class="badge">è¯„è®ºæ•°ï¼š${p.user_ratings_total ?? 'â€”'}</span>
            ${p.price_level != null ? `<span class="badge">ä»·ä½ï¼š${'ğŸ’²'.repeat(p.price_level + 1)}</span>` : ''}
          </div>
          <div class="addr">${escapeHtml(p.vicinity || p.formatted_address || '')}</div>
        `;
        div.addEventListener('click', () => {
          // æ‰¾åˆ°å¯¹åº” marker
          const marker = markers[idx];
          selectPlace(p, marker);
        });
        resultsEl.appendChild(div);
      });
    }

    function selectPlace(place, marker) {
      if (marker) {
        map.panTo(marker.getPosition());
        infoWindow.setContent(`<div style="font-weight:600;">${escapeHtml(place.name || '')}</div><div style="font-size:12px;color:#4b5563;">${escapeHtml(place.vicinity || '')}</div>`);
        infoWindow.open(map, marker);
      }
      // æ‹‰è¯¦ç»†ä¿¡æ¯
      if (place.place_id) {
        placesService.getDetails({
          placeId: place.place_id,
          fields: ['name','formatted_address','international_phone_number','website','rating','price_level','opening_hours','url','photos','geometry']
        }, (details, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && details) {
            renderDetails(details);
          } else {
            // å¦‚æœè¯¦æƒ…å¤±è´¥ä¹Ÿè‡³å°‘æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
            renderDetails({
              name: place.name,
              formatted_address: place.vicinity || place.formatted_address,
              rating: place.rating,
              price_level: place.price_level
            });
          }
        });
      }
    }

    function renderDetails(d) {
      detailsEl.style.display = 'block';
      const opening = (d.opening_hours?.weekday_text || []).map(line => `<div>${escapeHtml(line)}</div>`).join('') || 'â€”';
      const photoUrl = d.photos?.[0]?.getUrl({maxWidth: 640, maxHeight: 320});
      detailsEl.innerHTML = `
        ${photoUrl ? `<img src="${photoUrl}" alt="photo" style="width:100%;height:auto;border-radius:10px;margin-bottom:8px;" />` : ''}
        <div class="title">${escapeHtml(d.name || 'â€”')}</div>
        <div class="row"><b>åœ°å€ï¼š</b>${escapeHtml(d.formatted_address || 'â€”')}</div>
        <div class="row"><b>ç”µè¯ï¼š</b>${escapeHtml(d.international_phone_number || 'â€”')}</div>
        <div class="row"><b>è¯„åˆ†ï¼š</b>${d.rating ?? 'â€”'} &nbsp;&nbsp; <b>ä»·ä½ï¼š</b>${d.price_level != null ? 'ğŸ’²'.repeat(d.price_level + 1) : 'â€”'}</div>
        <div class="row"><b>è¥ä¸šæ—¶é—´ï¼š</b><div style="margin-top:4px;">${opening}</div></div>
        <div class="row"><b>é“¾æ¥ï¼š</b>
          ${(d.website ? `<a href="${d.website}" target="_blank" rel="noopener">å®˜ç½‘</a>` : 'â€”')}
          ${(d.url ? ` &nbsp;|&nbsp; <a href="${d.url}" target="_blank" rel="noopener">åœ¨ Google Maps æ‰“å¼€</a>` : '')}
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
  </script>
</body>
</html>
